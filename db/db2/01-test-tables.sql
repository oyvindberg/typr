-- DB2 Test Schema for Typr
-- This schema tests various DB2 data types

CONNECT TO typr;

-- Test table with all NOT NULL columns
CREATE TABLE db2test (
    -- Integer types
    smallint_col      SMALLINT          NOT NULL,
    int_col           INTEGER           NOT NULL,
    bigint_col        BIGINT            NOT NULL,

    -- Fixed-point types
    decimal_col       DECIMAL(10, 2)    NOT NULL,
    numeric_col       NUMERIC(15, 4)    NOT NULL,
    decfloat16_col    DECFLOAT(16)      NOT NULL,
    decfloat34_col    DECFLOAT(34)      NOT NULL,

    -- Floating-point types
    real_col          REAL              NOT NULL,
    double_col        DOUBLE            NOT NULL,

    -- Boolean (DB2 11.1+)
    bool_col          BOOLEAN           NOT NULL,

    -- Character types
    char_col          CHAR(10)          NOT NULL,
    varchar_col       VARCHAR(255)      NOT NULL,
    clob_col          CLOB              NOT NULL,

    -- Graphic types (DBCS)
    graphic_col       GRAPHIC(10)       NOT NULL,
    vargraphic_col    VARGRAPHIC(255)   NOT NULL,

    -- Binary types
    binary_col        BINARY(16)        NOT NULL,
    varbinary_col     VARBINARY(255)    NOT NULL,
    blob_col          BLOB              NOT NULL,

    -- Date/Time types
    date_col          DATE              NOT NULL,
    time_col          TIME              NOT NULL,
    timestamp_col     TIMESTAMP         NOT NULL,
    timestamp6_col    TIMESTAMP(6)      NOT NULL,
    timestamp12_col   TIMESTAMP(12)     NOT NULL,

    -- XML type
    xml_col           XML               NOT NULL,

    PRIMARY KEY (int_col)
);

-- Test table with all NULLABLE columns
CREATE TABLE db2testnull (
    -- Integer types
    smallint_col      SMALLINT,
    int_col           INTEGER,
    bigint_col        BIGINT,

    -- Fixed-point types
    decimal_col       DECIMAL(10, 2),
    numeric_col       NUMERIC(15, 4),
    decfloat16_col    DECFLOAT(16),
    decfloat34_col    DECFLOAT(34),

    -- Floating-point types
    real_col          REAL,
    double_col        DOUBLE,

    -- Boolean (DB2 11.1+)
    bool_col          BOOLEAN,

    -- Character types
    char_col          CHAR(10),
    varchar_col       VARCHAR(255),
    clob_col          CLOB,

    -- Graphic types (DBCS)
    graphic_col       GRAPHIC(10),
    vargraphic_col    VARGRAPHIC(255),

    -- Binary types
    binary_col        BINARY(16),
    varbinary_col     VARBINARY(255),
    blob_col          BLOB,

    -- Date/Time types
    date_col          DATE,
    time_col          TIME,
    timestamp_col     TIMESTAMP,
    timestamp6_col    TIMESTAMP(6),
    timestamp12_col   TIMESTAMP(12),

    -- XML type
    xml_col           XML
);

-- Test table for identity columns (GENERATED ALWAYS)
CREATE TABLE db2test_identity_always (
    id                INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY,
    name              VARCHAR(250) NOT NULL,
    PRIMARY KEY (id)
);

-- Test table for identity columns (GENERATED BY DEFAULT)
CREATE TABLE db2test_identity_default (
    id                INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    name              VARCHAR(250) NOT NULL,
    PRIMARY KEY (id)
);

-- Table with constraints
CREATE TABLE customers (
    customer_id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE orders (
    order_id INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    customer_id INTEGER NOT NULL,
    order_date DATE NOT NULL DEFAULT CURRENT_DATE,
    total_amount DECIMAL(12, 2),
    status VARCHAR(20) DEFAULT 'pending',
    CONSTRAINT fk_customer FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
);

-- Composite primary key table
CREATE TABLE order_items (
    order_id INTEGER NOT NULL,
    item_number INTEGER NOT NULL,
    product_name VARCHAR(100) NOT NULL,
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL,
    PRIMARY KEY (order_id, item_number),
    CONSTRAINT fk_order FOREIGN KEY (order_id) REFERENCES orders(order_id)
);

-- Table for testing nullability
CREATE TABLE nullability_test (
    id INTEGER NOT NULL,
    required_col VARCHAR(50) NOT NULL,
    optional_col VARCHAR(50),
    defaulted_col VARCHAR(50) DEFAULT 'default_value'
);

-- Test table with unique constraints
CREATE TABLE db2test_unique (
    id INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    code VARCHAR(50) NOT NULL,
    category VARCHAR(50) NOT NULL,
    CONSTRAINT uk_email UNIQUE (email),
    CONSTRAINT uk_code_category UNIQUE (code, category)
);

-- View for testing view generation
CREATE VIEW customer_order_summary AS
SELECT
    c.customer_id,
    c.name,
    COUNT(o.order_id) AS order_count,
    COALESCE(SUM(o.total_amount), 0) AS total_spent
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.name;

-- Distinct type (user-defined type)
CREATE DISTINCT TYPE email_address AS VARCHAR(255) WITH COMPARISONS;
CREATE DISTINCT TYPE money_amount AS DECIMAL(12, 2) WITH COMPARISONS;

-- Table using distinct types
CREATE TABLE distinct_type_test (
    id INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    email email_address NOT NULL,
    balance money_amount
);

-- Table with check constraints
CREATE TABLE check_constraint_test (
    id INTEGER NOT NULL PRIMARY KEY,
    age INTEGER NOT NULL,
    status VARCHAR(20) NOT NULL,
    price DECIMAL(10, 2),
    CONSTRAINT chk_age CHECK (age >= 0 AND age <= 150),
    CONSTRAINT chk_status CHECK (status IN ('active', 'inactive', 'pending')),
    CONSTRAINT chk_price CHECK (price >= 0)
);

-- Table with identity column with specific parameters
CREATE TABLE identity_params_test (
    id INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 100 INCREMENT BY 5 MINVALUE 1 MAXVALUE 10000 NO CYCLE) PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);

-- Materialized Query Table (MQT) - DB2's version of materialized views
CREATE TABLE customer_stats AS (
    SELECT
        c.customer_id,
        c.name AS customer_name,
        COUNT(o.order_id) AS total_orders,
        COALESCE(SUM(o.total_amount), 0) AS total_revenue
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id, c.name
) DATA INITIALLY DEFERRED REFRESH DEFERRED;

-- Add comments to tables and columns
COMMENT ON TABLE customers IS 'Customer master table containing all customer information';
COMMENT ON COLUMN customers.customer_id IS 'Unique identifier for the customer';
COMMENT ON COLUMN customers.name IS 'Full name of the customer';
COMMENT ON COLUMN customers.email IS 'Email address used for contact and login';

COMMENT ON TABLE orders IS 'Order records for all customer purchases';
COMMENT ON COLUMN orders.order_id IS 'Unique order identifier';
COMMENT ON COLUMN orders.total_amount IS 'Total monetary value of the order';

-- Sample data
INSERT INTO customers (name, email) VALUES ('Alice', 'alice@example.com');
INSERT INTO customers (name, email) VALUES ('Bob', 'bob@example.com');

-- Refresh the MQT with initial data
REFRESH TABLE customer_stats;
