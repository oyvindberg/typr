package testdb;

import static org.junit.Assert.*;

import java.math.BigDecimal;
import java.util.Optional;
import java.util.Random;
import org.junit.Test;
import testdb.check_constraint_test.*;
import testdb.customer_order_summary.*;
import testdb.customer_stats.*;
import testdb.distinct_type_test.*;
import testdb.identity_params_test.*;
import testdb.nullability_test.*;

/**
 * Tests for DB2-specific features: distinct types, check constraints, identity columns, and
 * materialized views.
 */
public class DatabaseFeaturesTest {
  private final TestInsert testInsert = new TestInsert(new Random(42));
  private final DistinctTypeTestRepoImpl distinctTypeRepo = new DistinctTypeTestRepoImpl();
  private final CheckConstraintTestRepoImpl checkConstraintRepo = new CheckConstraintTestRepoImpl();
  private final IdentityParamsTestRepoImpl identityParamsRepo = new IdentityParamsTestRepoImpl();
  private final NullabilityTestRepoImpl nullabilityRepo = new NullabilityTestRepoImpl();
  private final CustomerOrderSummaryViewRepoImpl summaryViewRepo =
      new CustomerOrderSummaryViewRepoImpl();
  private final CustomerStatsMVRepoImpl statsMVRepo = new CustomerStatsMVRepoImpl();

  // ==================== Distinct Type Tests ====================

  @Test
  public void testEmailAddressDistinctType() {
    Db2TestHelper.run(
        c -> {
          var email = new EmailAddress("test@example.com");
          var row = testInsert.DistinctTypeTest(email).insert(c);

          assertNotNull(row);
          assertEquals(email, row.email());
          assertEquals("test@example.com", row.email().value());
        });
  }

  @Test
  public void testEmailAddressUpdate() {
    Db2TestHelper.run(
        c -> {
          var email = new EmailAddress("original@example.com");
          var row = testInsert.DistinctTypeTest(email).insert(c);

          var newEmail = new EmailAddress("updated@example.com");
          var updated = row.withEmail(newEmail);
          distinctTypeRepo.update(updated, c);

          var found = distinctTypeRepo.selectById(row.id(), c).orElseThrow();
          assertEquals(newEmail, found.email());
        });
  }

  @Test
  public void testEmailAddressDSLQuery() {
    Db2TestHelper.run(
        c -> {
          var email1 = new EmailAddress("user1@company.com");
          var email2 = new EmailAddress("user2@company.com");
          testInsert.DistinctTypeTest(email1).insert(c);
          testInsert.DistinctTypeTest(email2).insert(c);

          var results =
              distinctTypeRepo.select().where(row -> row.email().isEqual(email1)).toList(c);

          assertEquals(1, results.size());
          assertEquals(email1, results.get(0).email());
        });
  }

  @Test
  public void testMoneyAmountDistinctType() {
    Db2TestHelper.run(
        c -> {
          var email = new EmailAddress("money@test.com");
          var money = new MoneyAmount(new BigDecimal("999.99"));
          var row =
              testInsert
                  .DistinctTypeTest(email)
                  .with(r -> r.withBalance(Optional.of(money)))
                  .insert(c);

          assertTrue(row.balance().isPresent());
          assertEquals(money, row.balance().get());
          assertEquals(0, new BigDecimal("999.99").compareTo(row.balance().get().value()));
        });
  }

  // ==================== Check Constraint Tests ====================

  @Test
  public void testCheckConstraintValidAge() {
    Db2TestHelper.run(
        c -> {
          var row = testInsert.CheckConstraintTest(25, "active").insert(c);

          assertNotNull(row);
          assertEquals(25, row.age().intValue());
          assertEquals("active", row.status());
        });
  }

  @Test
  public void testCheckConstraintMinAge() {
    Db2TestHelper.run(
        c -> {
          var row = testInsert.CheckConstraintTest(18, "active").insert(c);
          assertEquals(18, row.age().intValue());
        });
  }

  @Test
  public void testCheckConstraintMaxAge() {
    Db2TestHelper.run(
        c -> {
          var row = testInsert.CheckConstraintTest(120, "inactive").insert(c);
          assertEquals(120, row.age().intValue());
        });
  }

  @Test
  public void testCheckConstraintStatusValues() {
    Db2TestHelper.run(
        c -> {
          var active = testInsert.CheckConstraintTest(30, "active").insert(c);
          var inactive = testInsert.CheckConstraintTest(30, "inactive").insert(c);
          var pending = testInsert.CheckConstraintTest(30, "pending").insert(c);

          assertEquals("active", active.status());
          assertEquals("inactive", inactive.status());
          assertEquals("pending", pending.status());
        });
  }

  // ==================== Identity Column Tests ====================

  @Test
  public void testIdentityAlwaysAutoGenerated() {
    Db2TestHelper.run(
        c -> {
          var row1 = testInsert.Db2testIdentityAlways().insert(c);
          var row2 = testInsert.Db2testIdentityAlways().insert(c);
          var row3 = testInsert.Db2testIdentityAlways().insert(c);

          assertNotNull(row1.id());
          assertNotNull(row2.id());
          assertNotNull(row3.id());

          assertNotEquals(row1.id(), row2.id());
          assertNotEquals(row2.id(), row3.id());
        });
  }

  @Test
  public void testIdentityDefaultAutoGenerated() {
    Db2TestHelper.run(
        c -> {
          var row1 = testInsert.Db2testIdentityDefault().insert(c);
          var row2 = testInsert.Db2testIdentityDefault().insert(c);

          assertNotNull(row1.id());
          assertNotNull(row2.id());
          assertNotEquals(row1.id(), row2.id());
        });
  }

  @Test
  public void testIdentityParamsTest() {
    Db2TestHelper.run(
        c -> {
          var row = testInsert.IdentityParamsTest().insert(c);

          assertNotNull(row);
          assertNotNull(row.id());
        });
  }

  // ==================== Nullability Tests ====================

  @Test
  public void testRequiredColumnNotNull() {
    Db2TestHelper.run(
        c -> {
          var row = testInsert.NullabilityTest().insert(c);

          assertNotNull(row.requiredCol());
        });
  }

  @Test
  public void testOptionalColumnCanBeNull() {
    Db2TestHelper.run(
        c -> {
          var row =
              testInsert.NullabilityTest().with(r -> r.withOptionalCol(Optional.empty())).insert(c);

          assertTrue(row.optionalCol().isEmpty());
        });
  }

  @Test
  public void testOptionalColumnWithValue() {
    Db2TestHelper.run(
        c -> {
          var row =
              testInsert
                  .NullabilityTest()
                  .with(r -> r.withOptionalCol(Optional.of("has value")))
                  .insert(c);

          assertEquals(Optional.of("has value"), row.optionalCol());
        });
  }

  // ==================== View Tests ====================

  @Test
  public void testCustomerOrderSummaryView() {
    Db2TestHelper.run(
        c -> {
          var customer = testInsert.Customers().insert(c);
          testInsert
              .Orders(customer.customerId())
              .with(r -> r.withTotalAmount(Optional.of(new BigDecimal("100.00"))))
              .insert(c);
          testInsert
              .Orders(customer.customerId())
              .with(r -> r.withTotalAmount(Optional.of(new BigDecimal("200.00"))))
              .insert(c);

          var viewResults = summaryViewRepo.select().toList(c);

          assertTrue(viewResults.size() >= 1);
        });
  }

  @Test
  public void testCustomerStatsMaterializedView() {
    Db2TestHelper.run(
        c -> {
          var results = statsMVRepo.select().toList(c);

          assertNotNull(results);
        });
  }
}
