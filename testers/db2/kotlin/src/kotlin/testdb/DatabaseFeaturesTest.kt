package testdb

import org.junit.Assert.*
import org.junit.Test
import testdb.check_constraint_test.*
import testdb.customer_order_summary.*
import testdb.customer_stats.*
import testdb.customers.*
import testdb.distinct_type_test.*
import testdb.identity_params_test.*
import testdb.nullability_test.*
import testdb.orders.*
import java.math.BigDecimal
import java.util.Random

/**
 * Tests for DB2-specific features: distinct types, check constraints, identity columns, and
 * materialized views.
 */
class DatabaseFeaturesTest {
    private val testInsert = TestInsert(Random(42))
    private val distinctTypeRepo = DistinctTypeTestRepoImpl()
    private val checkConstraintRepo = CheckConstraintTestRepoImpl()
    private val identityParamsRepo = IdentityParamsTestRepoImpl()
    private val nullabilityRepo = NullabilityTestRepoImpl()
    private val summaryViewRepo = CustomerOrderSummaryViewRepoImpl()
    private val statsMVRepo = CustomerStatsMVRepoImpl()

    // ==================== Distinct Type Tests ====================

    @Test
    fun testEmailAddressDistinctType() {
        Db2TestHelper.run { c ->
            val email = EmailAddress("test@example.com")
            val row = testInsert.DistinctTypeTest(email = email, c = c)

            assertNotNull(row)
            assertEquals(email, row.email)
            assertEquals("test@example.com", row.email.value)
        }
    }

    @Test
    fun testEmailAddressUpdate() {
        Db2TestHelper.run { c ->
            val email = EmailAddress("original@example.com")
            val row = testInsert.DistinctTypeTest(email = email, c = c)

            val newEmail = EmailAddress("updated@example.com")
            val updated = row.copy(email = newEmail)
            distinctTypeRepo.update(updated, c)

            val found = distinctTypeRepo.selectById(row.id, c)!!
            assertEquals(newEmail, found.email)
        }
    }

    @Test
    fun testEmailAddressDSLQuery() {
        Db2TestHelper.run { c ->
            val email1 = EmailAddress("user1@company.com")
            val email2 = EmailAddress("user2@company.com")
            testInsert.DistinctTypeTest(email = email1, c = c)
            testInsert.DistinctTypeTest(email = email2, c = c)

            val results = distinctTypeRepo.select()
                .where { row -> row.email().isEqual(email1) }
                .toList(c)

            assertEquals(1, results.size)
            assertEquals(email1, results[0].email)
        }
    }

    @Test
    fun testMoneyAmountDistinctType() {
        Db2TestHelper.run { c ->
            val email = EmailAddress("money@test.com")
            val money = MoneyAmount(BigDecimal("999.99"))
            val row = testInsert.DistinctTypeTest(email = email, balance = money, c = c)

            assertNotNull(row.balance)
            assertEquals(money, row.balance)
            assertEquals(0, BigDecimal("999.99").compareTo(row.balance!!.value))
        }
    }

    // ==================== Check Constraint Tests ====================

    @Test
    fun testCheckConstraintValidAge() {
        Db2TestHelper.run { c ->
            val row = testInsert.CheckConstraintTest(age = 25, status = "active", c = c)

            assertNotNull(row)
            assertEquals(25, row.age)
            assertEquals("active", row.status)
        }
    }

    @Test
    fun testCheckConstraintMinAge() {
        Db2TestHelper.run { c ->
            val row = testInsert.CheckConstraintTest(age = 18, status = "active", c = c)
            assertEquals(18, row.age)
        }
    }

    @Test
    fun testCheckConstraintMaxAge() {
        Db2TestHelper.run { c ->
            val row = testInsert.CheckConstraintTest(age = 120, status = "inactive", c = c)
            assertEquals(120, row.age)
        }
    }

    @Test
    fun testCheckConstraintStatusValues() {
        Db2TestHelper.run { c ->
            val active = testInsert.CheckConstraintTest(age = 30, status = "active", c = c)
            val inactive = testInsert.CheckConstraintTest(age = 30, status = "inactive", c = c)
            val pending = testInsert.CheckConstraintTest(age = 30, status = "pending", c = c)

            assertEquals("active", active.status)
            assertEquals("inactive", inactive.status)
            assertEquals("pending", pending.status)
        }
    }

    // ==================== Identity Column Tests ====================

    @Test
    fun testIdentityAlwaysAutoGenerated() {
        Db2TestHelper.run { c ->
            val row1 = testInsert.Db2testIdentityAlways(name = "test1", c = c)
            val row2 = testInsert.Db2testIdentityAlways(name = "test2", c = c)
            val row3 = testInsert.Db2testIdentityAlways(name = "test3", c = c)

            assertNotNull(row1.id)
            assertNotNull(row2.id)
            assertNotNull(row3.id)

            assertNotEquals(row1.id, row2.id)
            assertNotEquals(row2.id, row3.id)
        }
    }

    @Test
    fun testIdentityDefaultAutoGenerated() {
        Db2TestHelper.run { c ->
            val row1 = testInsert.Db2testIdentityDefault(name = "test1", c = c)
            val row2 = testInsert.Db2testIdentityDefault(name = "test2", c = c)

            assertNotNull(row1.id)
            assertNotNull(row2.id)
            assertNotEquals(row1.id, row2.id)
        }
    }

    @Test
    fun testIdentityParamsTest() {
        Db2TestHelper.run { c ->
            val row = testInsert.IdentityParamsTest(name = "test", c = c)

            assertNotNull(row)
            assertNotNull(row.id)
        }
    }

    // ==================== Nullability Tests ====================

    @Test
    fun testRequiredColumnNotNull() {
        Db2TestHelper.run { c ->
            val row = testInsert.NullabilityTest(requiredCol = "required value", c = c)

            assertNotNull(row.requiredCol)
        }
    }

    @Test
    fun testOptionalColumnCanBeNull() {
        Db2TestHelper.run { c ->
            val row = testInsert.NullabilityTest(requiredCol = "required", optionalCol = null, c = c)

            assertNull(row.optionalCol)
        }
    }

    @Test
    fun testOptionalColumnWithValue() {
        Db2TestHelper.run { c ->
            val row = testInsert.NullabilityTest(requiredCol = "required", optionalCol = "has value", c = c)

            assertEquals("has value", row.optionalCol)
        }
    }

    // ==================== View Tests ====================

    @Test
    fun testCustomerOrderSummaryView() {
        Db2TestHelper.run { c ->
            val customer = testInsert.Customers(name = "View Test", email = "view@test.com", c = c)
            testInsert.Orders(customerId = customer.customerId, totalAmount = BigDecimal("100.00"), c = c)
            testInsert.Orders(customerId = customer.customerId, totalAmount = BigDecimal("200.00"), c = c)

            val viewResults = summaryViewRepo.select().toList(c)

            assertTrue(viewResults.size >= 1)
        }
    }

    @Test
    fun testCustomerStatsMaterializedView() {
        Db2TestHelper.run { c ->
            val results = statsMVRepo.select().toList(c)

            assertNotNull(results)
        }
    }
}
