/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package frontpage.frontpage.product_category;

import frontpage.frontpage.category.CategoryId;
import frontpage.frontpage.product.ProductId;
import java.sql.Connection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import typo.dsl.DeleteBuilder;
import typo.dsl.SelectBuilder;
import typo.dsl.UpdateBuilder;
import typo.runtime.internal.arrayMap;
import typo.runtime.streamingInsert;
import static typo.runtime.Fragment.interpolate;
import static typo.runtime.internal.stringInterpolator.str;

public class ProductCategoryRepoImpl implements ProductCategoryRepo {
  public DeleteBuilder<ProductCategoryFields, ProductCategoryRow> delete() {
    return DeleteBuilder.of("frontpage.product_category", ProductCategoryFields.structure());
  };

  public Boolean deleteById(
    ProductCategoryId compositeId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
      delete from "frontpage"."product_category" where "product_id" = 
      """),
      ProductId.pgType.encode(compositeId.productId()),
      typo.runtime.Fragment.lit("""
       AND "category_id" = 
      """),
      CategoryId.pgType.encode(compositeId.categoryId()),
      typo.runtime.Fragment.lit("")
    ).update().runUnchecked(c) > 0;
  };

  public Integer deleteByIds(
    ProductCategoryId[] compositeIds,
    Connection c
  ) {
    ProductId[] productId = arrayMap.map(compositeIds, ProductCategoryId::productId, ProductId.class);;
      CategoryId[] categoryId = arrayMap.map(compositeIds, ProductCategoryId::categoryId, CategoryId.class);;
    return interpolate(
             typo.runtime.Fragment.lit("""
                delete
                from "frontpage"."product_category"
                where ("product_id", "category_id")
                in (select unnest("""),
             ProductId.pgTypeArray.encode(productId),
             typo.runtime.Fragment.lit("::uuid[]), unnest("),
             CategoryId.pgTypeArray.encode(categoryId),
             typo.runtime.Fragment.lit("""
             ::uuid[]))

             """)
           ).update().runUnchecked(c);
  };

  public ProductCategoryRow insert(
    ProductCategoryRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         insert into "frontpage"."product_category"("product_id", "category_id")
         values ("""),
      ProductId.pgType.encode(unsaved.productId()),
      typo.runtime.Fragment.lit("::uuid, "),
      CategoryId.pgType.encode(unsaved.categoryId()),
      typo.runtime.Fragment.lit("""
         ::uuid)
         returning "product_id", "category_id"
      """)
    )
      .updateReturning(ProductCategoryRow._rowParser.exactlyOne()).runUnchecked(c);
  };

  public Long insertStreaming(
    Iterator<ProductCategoryRow> unsaved,
    Integer batchSize,
    Connection c
  ) {
    return streamingInsert.insertUnchecked(str("""
    COPY "frontpage"."product_category"("product_id", "category_id") FROM STDIN
    """), batchSize, unsaved, c, ProductCategoryRow.pgText);
  };

  public SelectBuilder<ProductCategoryFields, ProductCategoryRow> select() {
    return SelectBuilder.of("frontpage.product_category", ProductCategoryFields.structure(), ProductCategoryRow._rowParser);
  };

  public List<ProductCategoryRow> selectAll(Connection c) {
    return interpolate(typo.runtime.Fragment.lit("""
       select "product_id", "category_id"
       from "frontpage"."product_category"
    """)).as(ProductCategoryRow._rowParser.all()).runUnchecked(c);
  };

  public Optional<ProductCategoryRow> selectById(
    ProductCategoryId compositeId,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         select "product_id", "category_id"
         from "frontpage"."product_category"
         where "product_id" = """),
      ProductId.pgType.encode(compositeId.productId()),
      typo.runtime.Fragment.lit("""
       AND "category_id" = 
      """),
      CategoryId.pgType.encode(compositeId.categoryId()),
      typo.runtime.Fragment.lit("")
    ).as(ProductCategoryRow._rowParser.first()).runUnchecked(c);
  };

  public List<ProductCategoryRow> selectByIds(
    ProductCategoryId[] compositeIds,
    Connection c
  ) {
    ProductId[] productId = arrayMap.map(compositeIds, ProductCategoryId::productId, ProductId.class);;
      CategoryId[] categoryId = arrayMap.map(compositeIds, ProductCategoryId::categoryId, CategoryId.class);;
    return interpolate(
             typo.runtime.Fragment.lit("""
                select "product_id", "category_id"
                from "frontpage"."product_category"
                where ("product_id", "category_id")
                in (select unnest("""),
             ProductId.pgTypeArray.encode(productId),
             typo.runtime.Fragment.lit("::uuid[]), unnest("),
             CategoryId.pgTypeArray.encode(categoryId),
             typo.runtime.Fragment.lit("""
             ::uuid[]))

             """)
           ).as(ProductCategoryRow._rowParser.all()).runUnchecked(c);
  };

  public Map<ProductCategoryId, ProductCategoryRow> selectByIdsTracked(
    ProductCategoryId[] compositeIds,
    Connection c
  ) {
    Map<ProductCategoryId, ProductCategoryRow> ret = new HashMap<>();;
      selectByIds(compositeIds, c).forEach(row -> ret.put(row.compositeId(), row));
    return ret;
  };

  public UpdateBuilder<ProductCategoryFields, ProductCategoryRow> update() {
    return UpdateBuilder.of("frontpage.product_category", ProductCategoryFields.structure(), ProductCategoryRow._rowParser.all());
  };

  public ProductCategoryRow upsert(
    ProductCategoryRow unsaved,
    Connection c
  ) {
    return interpolate(
      typo.runtime.Fragment.lit("""
         insert into "frontpage"."product_category"("product_id", "category_id")
         values ("""),
      ProductId.pgType.encode(unsaved.productId()),
      typo.runtime.Fragment.lit("::uuid, "),
      CategoryId.pgType.encode(unsaved.categoryId()),
      typo.runtime.Fragment.lit("""
         ::uuid)
         on conflict ("product_id", "category_id")
         do update set "product_id" = EXCLUDED."product_id"
         returning "product_id", "category_id"
      """)
    )
      .updateReturning(ProductCategoryRow._rowParser.exactlyOne())
      .runUnchecked(c);
  };

  public List<ProductCategoryRow> upsertBatch(
    Iterator<ProductCategoryRow> unsaved,
    Connection c
  ) {
    return interpolate(typo.runtime.Fragment.lit("""
                insert into "frontpage"."product_category"("product_id", "category_id")
                values (?::uuid, ?::uuid)
                on conflict ("product_id", "category_id")
                do nothing
                returning "product_id", "category_id"
             """))
      .updateManyReturning(ProductCategoryRow._rowParser, unsaved)
      .runUnchecked(c);
  };

  /** NOTE: this functionality is not safe if you use auto-commit mode! it runs 3 SQL statements */
  public Integer upsertStreaming(
    Iterator<ProductCategoryRow> unsaved,
    Integer batchSize,
    Connection c
  ) {
    interpolate(typo.runtime.Fragment.lit("""
      create temporary table product_category_TEMP (like "frontpage"."product_category") on commit drop
      """)).update().runUnchecked(c);
      streamingInsert.insertUnchecked(str("""
      copy product_category_TEMP("product_id", "category_id") from stdin
      """), batchSize, unsaved, c, ProductCategoryRow.pgText);
    return interpolate(typo.runtime.Fragment.lit("""
              insert into "frontpage"."product_category"("product_id", "category_id")
              select * from product_category_TEMP
              on conflict ("product_id", "category_id")
              do nothing
              ;
              drop table product_category_TEMP;""")).update().runUnchecked(c);
  };
}