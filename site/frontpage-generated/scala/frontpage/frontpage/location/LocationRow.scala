/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package frontpage.frontpage.location

import anorm.Column
import anorm.RowParser
import anorm.Success
import frontpage.Text
import frontpage.customtypes.Defaulted
import frontpage.customtypes.TypoInet
import frontpage.customtypes.TypoJsonb
import frontpage.customtypes.TypoPoint
import frontpage.customtypes.TypoPolygon
import play.api.libs.json.JsObject
import play.api.libs.json.JsResult
import play.api.libs.json.JsValue
import play.api.libs.json.OWrites
import play.api.libs.json.Reads
import play.api.libs.json.Writes
import scala.collection.immutable.ListMap
import scala.util.Try

/** Table: frontpage.location
 * Primary key: id
 */
case class LocationRow(
  /** Default: gen_random_uuid() */
  id: LocationId,
  name: String,
  position: Option[TypoPoint],
  area: Option[TypoPolygon],
  ipRange: Option[TypoInet],
  /** Default: '{}'::jsonb */
  metadata: Option[TypoJsonb]
) {
  def toUnsavedRow(
    id: Defaulted[LocationId],
    metadata: Defaulted[Option[TypoJsonb]] = Defaulted.Provided(this.metadata)
  ): LocationRowUnsaved = {
    new LocationRowUnsaved(
      name,
      position,
      area,
      ipRange,
      id,
      metadata
    )
  }
}

object LocationRow {
  given pgText: Text[LocationRow] = {
    Text.instance[LocationRow]{ (row, sb) =>
      LocationId.pgText.unsafeEncode(row.id, sb)
      sb.append(Text.DELIMETER)
      Text.stringInstance.unsafeEncode(row.name, sb)
      sb.append(Text.DELIMETER)
      Text.option(using TypoPoint.pgText).unsafeEncode(row.position, sb)
      sb.append(Text.DELIMETER)
      Text.option(using TypoPolygon.pgText).unsafeEncode(row.area, sb)
      sb.append(Text.DELIMETER)
      Text.option(using TypoInet.pgText).unsafeEncode(row.ipRange, sb)
      sb.append(Text.DELIMETER)
      Text.option(using TypoJsonb.pgText).unsafeEncode(row.metadata, sb)
    }
  }

  given reads: Reads[LocationRow] = {
    Reads[LocationRow](json => JsResult.fromTry(
        Try(
          LocationRow(
            id = json.\("id").as(LocationId.reads),
            name = json.\("name").as(Reads.StringReads),
            position = json.\("position").toOption.map(_.as(TypoPoint.reads)),
            area = json.\("area").toOption.map(_.as(TypoPolygon.reads)),
            ipRange = json.\("ip_range").toOption.map(_.as(TypoInet.reads)),
            metadata = json.\("metadata").toOption.map(_.as(TypoJsonb.reads))
          )
        )
      ),
    )
  }

  def rowParser(idx: Int): RowParser[LocationRow] = {
    RowParser[LocationRow] { row =>
      Success(
        LocationRow(
          id = row(idx + 0)(using LocationId.column),
          name = row(idx + 1)(using Column.columnToString),
          position = row(idx + 2)(using Column.columnToOption(using TypoPoint.column)),
          area = row(idx + 3)(using Column.columnToOption(using TypoPolygon.column)),
          ipRange = row(idx + 4)(using Column.columnToOption(using TypoInet.column)),
          metadata = row(idx + 5)(using Column.columnToOption(using TypoJsonb.column))
        )
      )
    }
  }

  given writes: OWrites[LocationRow] = {
    OWrites[LocationRow](o =>
      new JsObject(ListMap[String, JsValue](
        "id" -> LocationId.writes.writes(o.id),
        "name" -> Writes.StringWrites.writes(o.name),
        "position" -> Writes.OptionWrites(using TypoPoint.writes).writes(o.position),
        "area" -> Writes.OptionWrites(using TypoPolygon.writes).writes(o.area),
        "ip_range" -> Writes.OptionWrites(using TypoInet.writes).writes(o.ipRange),
        "metadata" -> Writes.OptionWrites(using TypoJsonb.writes).writes(o.metadata)
      ))
    )
  }
}