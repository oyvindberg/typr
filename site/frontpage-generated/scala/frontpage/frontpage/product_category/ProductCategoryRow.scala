/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package frontpage.frontpage.product_category

import anorm.RowParser
import anorm.Success
import frontpage.Text
import frontpage.frontpage.category.CategoryId
import frontpage.frontpage.product.ProductId
import play.api.libs.json.JsObject
import play.api.libs.json.JsResult
import play.api.libs.json.JsValue
import play.api.libs.json.OWrites
import play.api.libs.json.Reads
import scala.collection.immutable.ListMap
import scala.util.Try

/** Table: frontpage.product_category
 * Composite primary key: product_id, category_id
 */
case class ProductCategoryRow(
  /** Points to [[frontpage.frontpage.product.ProductRow.id]] */
  productId: ProductId,
  /** Points to [[frontpage.frontpage.category.CategoryRow.id]] */
  categoryId: CategoryId
) {
  def compositeId: ProductCategoryId = new ProductCategoryId(productId, categoryId)

  def id: ProductCategoryId = this.compositeId
}

object ProductCategoryRow {
  def apply(compositeId: ProductCategoryId): ProductCategoryRow = new ProductCategoryRow(compositeId.productId, compositeId.categoryId)

  given pgText: Text[ProductCategoryRow] = {
    Text.instance[ProductCategoryRow]{ (row, sb) =>
      ProductId.pgText.unsafeEncode(row.productId, sb)
      sb.append(Text.DELIMETER)
      CategoryId.pgText.unsafeEncode(row.categoryId, sb)
    }
  }

  given reads: Reads[ProductCategoryRow] = {
    Reads[ProductCategoryRow](json => JsResult.fromTry(
        Try(
          ProductCategoryRow(
            productId = json.\("product_id").as(ProductId.reads),
            categoryId = json.\("category_id").as(CategoryId.reads)
          )
        )
      ),
    )
  }

  def rowParser(idx: Int): RowParser[ProductCategoryRow] = {
    RowParser[ProductCategoryRow] { row =>
      Success(
        ProductCategoryRow(
          productId = row(idx + 0)(using ProductId.column),
          categoryId = row(idx + 1)(using CategoryId.column)
        )
      )
    }
  }

  given writes: OWrites[ProductCategoryRow] = {
    OWrites[ProductCategoryRow](o =>
      new JsObject(ListMap[String, JsValue](
        "product_id" -> ProductId.writes.writes(o.productId),
        "category_id" -> CategoryId.writes.writes(o.categoryId)
      ))
    )
  }
}