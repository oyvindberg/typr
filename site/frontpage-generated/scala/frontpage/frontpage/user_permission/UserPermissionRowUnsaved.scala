/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package frontpage.frontpage.user_permission

import frontpage.Text
import frontpage.customtypes.Defaulted
import frontpage.customtypes.Defaulted.UseDefault
import frontpage.customtypes.TypoLocalDateTime
import frontpage.frontpage.permission.PermissionId
import frontpage.frontpage.user.UserId
import play.api.libs.json.JsObject
import play.api.libs.json.JsResult
import play.api.libs.json.JsValue
import play.api.libs.json.OWrites
import play.api.libs.json.Reads
import play.api.libs.json.Writes
import scala.collection.immutable.ListMap
import scala.util.Try

/** This class corresponds to a row in table `frontpage.user_permission` which has not been persisted yet */
case class UserPermissionRowUnsaved(
  /** Points to [[frontpage.frontpage.user.UserRow.id]] */
  userId: UserId,
  /** Points to [[frontpage.frontpage.permission.PermissionRow.id]] */
  permissionId: PermissionId,
  /** Default: now() */
  grantedAt: Defaulted[Option[TypoLocalDateTime]] = new UseDefault()
) {
  def toRow(grantedAtDefault: => Option[TypoLocalDateTime]): UserPermissionRow = new UserPermissionRow(userId = userId, permissionId = permissionId, grantedAt = grantedAt.getOrElse(grantedAtDefault))
}

object UserPermissionRowUnsaved {
  given pgText: Text[UserPermissionRowUnsaved] = {
    Text.instance[UserPermissionRowUnsaved]{ (row, sb) =>
      UserId.pgText.unsafeEncode(row.userId, sb)
      sb.append(Text.DELIMETER)
      PermissionId.pgText.unsafeEncode(row.permissionId, sb)
      sb.append(Text.DELIMETER)
      Defaulted.pgText(using Text.option(using TypoLocalDateTime.pgText)).unsafeEncode(row.grantedAt, sb)
    }
  }

  given reads: Reads[UserPermissionRowUnsaved] = {
    Reads[UserPermissionRowUnsaved](json => JsResult.fromTry(
        Try(
          UserPermissionRowUnsaved(
            userId = json.\("user_id").as(UserId.reads),
            permissionId = json.\("permission_id").as(PermissionId.reads),
            grantedAt = json.\("granted_at").as(Defaulted.readsOpt(using TypoLocalDateTime.reads))
          )
        )
      ),
    )
  }

  given writes: OWrites[UserPermissionRowUnsaved] = {
    OWrites[UserPermissionRowUnsaved](o =>
      new JsObject(ListMap[String, JsValue](
        "user_id" -> UserId.writes.writes(o.userId),
        "permission_id" -> PermissionId.writes.writes(o.permissionId),
        "granted_at" -> Defaulted.writes(using Writes.OptionWrites(using TypoLocalDateTime.writes)).writes(o.grantedAt)
      ))
    )
  }
}