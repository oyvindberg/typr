/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package frontpage.frontpage.user_permission

import anorm.Column
import anorm.RowParser
import anorm.Success
import frontpage.Text
import frontpage.customtypes.Defaulted
import frontpage.customtypes.TypoLocalDateTime
import frontpage.frontpage.permission.PermissionId
import frontpage.frontpage.user.UserId
import play.api.libs.json.JsObject
import play.api.libs.json.JsResult
import play.api.libs.json.JsValue
import play.api.libs.json.OWrites
import play.api.libs.json.Reads
import play.api.libs.json.Writes
import scala.collection.immutable.ListMap
import scala.util.Try

/** Table: frontpage.user_permission
 * Composite primary key: user_id, permission_id
 */
case class UserPermissionRow(
  /** Points to [[frontpage.frontpage.user.UserRow.id]] */
  userId: UserId,
  /** Points to [[frontpage.frontpage.permission.PermissionRow.id]] */
  permissionId: PermissionId,
  /** Default: now() */
  grantedAt: Option[TypoLocalDateTime]
) {
  def compositeId: UserPermissionId = new UserPermissionId(userId, permissionId)

  def id: UserPermissionId = this.compositeId

  def toUnsavedRow(grantedAt: Defaulted[Option[TypoLocalDateTime]] = Defaulted.Provided(this.grantedAt)): UserPermissionRowUnsaved = new UserPermissionRowUnsaved(userId, permissionId, grantedAt)
}

object UserPermissionRow {
  def apply(
    compositeId: UserPermissionId,
    grantedAt: Option[TypoLocalDateTime]
  ): UserPermissionRow = new UserPermissionRow(compositeId.userId, compositeId.permissionId, grantedAt)

  given pgText: Text[UserPermissionRow] = {
    Text.instance[UserPermissionRow]{ (row, sb) =>
      UserId.pgText.unsafeEncode(row.userId, sb)
      sb.append(Text.DELIMETER)
      PermissionId.pgText.unsafeEncode(row.permissionId, sb)
      sb.append(Text.DELIMETER)
      Text.option(using TypoLocalDateTime.pgText).unsafeEncode(row.grantedAt, sb)
    }
  }

  given reads: Reads[UserPermissionRow] = {
    Reads[UserPermissionRow](json => JsResult.fromTry(
        Try(
          UserPermissionRow(
            userId = json.\("user_id").as(UserId.reads),
            permissionId = json.\("permission_id").as(PermissionId.reads),
            grantedAt = json.\("granted_at").toOption.map(_.as(TypoLocalDateTime.reads))
          )
        )
      ),
    )
  }

  def rowParser(idx: Int): RowParser[UserPermissionRow] = {
    RowParser[UserPermissionRow] { row =>
      Success(
        UserPermissionRow(
          userId = row(idx + 0)(using UserId.column),
          permissionId = row(idx + 1)(using PermissionId.column),
          grantedAt = row(idx + 2)(using Column.columnToOption(using TypoLocalDateTime.column))
        )
      )
    }
  }

  given writes: OWrites[UserPermissionRow] = {
    OWrites[UserPermissionRow](o =>
      new JsObject(ListMap[String, JsValue](
        "user_id" -> UserId.writes.writes(o.userId),
        "permission_id" -> PermissionId.writes.writes(o.permissionId),
        "granted_at" -> Writes.OptionWrites(using TypoLocalDateTime.writes).writes(o.grantedAt)
      ))
    )
  }
}