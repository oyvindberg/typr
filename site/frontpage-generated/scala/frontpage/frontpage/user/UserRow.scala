/**
 * File has been automatically generated by `typo`.
 *
 * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
 */
package frontpage.frontpage.user

import anorm.Column
import anorm.RowParser
import anorm.Success
import frontpage.Text
import frontpage.customtypes.Defaulted
import frontpage.customtypes.TypoLocalDateTime
import frontpage.frontpage.Email
import frontpage.frontpage.UserRole
import frontpage.frontpage.UserStatus
import frontpage.frontpage.department.DepartmentId
import play.api.libs.json.JsObject
import play.api.libs.json.JsResult
import play.api.libs.json.JsValue
import play.api.libs.json.OWrites
import play.api.libs.json.Reads
import play.api.libs.json.Writes
import scala.collection.immutable.ListMap
import scala.util.Try

/** Table: frontpage.user
 * Primary key: id
 */
case class UserRow(
  /** Default: gen_random_uuid() */
  id: UserId,
  email: Email,
  name: String,
  /** Default: now() */
  createdAt: Option[TypoLocalDateTime],
  /** Points to [[frontpage.frontpage.department.DepartmentRow.id]] */
  departmentId: Option[DepartmentId],
  /** Default: 'active'::frontpage.user_status */
  status: Option[UserStatus],
  /** Default: false */
  verified: Option[Boolean],
  /** Points to [[frontpage.frontpage.user.UserRow.id]] */
  managerId: Option[UserId],
  /** Default: 'employee'::frontpage.user_role */
  role: Option[UserRole]
) {
  def toUnsavedRow(
    id: Defaulted[UserId],
    createdAt: Defaulted[Option[TypoLocalDateTime]] = Defaulted.Provided(this.createdAt),
    status: Defaulted[Option[UserStatus]] = Defaulted.Provided(this.status),
    verified: Defaulted[Option[Boolean]] = Defaulted.Provided(this.verified),
    role: Defaulted[Option[UserRole]] = Defaulted.Provided(this.role)
  ): UserRowUnsaved = {
    new UserRowUnsaved(
      email,
      name,
      departmentId,
      managerId,
      id,
      createdAt,
      status,
      verified,
      role
    )
  }
}

object UserRow {
  given pgText: Text[UserRow] = {
    Text.instance[UserRow]{ (row, sb) =>
      UserId.pgText.unsafeEncode(row.id, sb)
      sb.append(Text.DELIMETER)
      Email.pgText.unsafeEncode(row.email, sb)
      sb.append(Text.DELIMETER)
      Text.stringInstance.unsafeEncode(row.name, sb)
      sb.append(Text.DELIMETER)
      Text.option(using TypoLocalDateTime.pgText).unsafeEncode(row.createdAt, sb)
      sb.append(Text.DELIMETER)
      Text.option(using DepartmentId.pgText).unsafeEncode(row.departmentId, sb)
      sb.append(Text.DELIMETER)
      Text.option(using UserStatus.pgText).unsafeEncode(row.status, sb)
      sb.append(Text.DELIMETER)
      Text.option(using Text.booleanInstance).unsafeEncode(row.verified, sb)
      sb.append(Text.DELIMETER)
      Text.option(using UserId.pgText).unsafeEncode(row.managerId, sb)
      sb.append(Text.DELIMETER)
      Text.option(using UserRole.pgText).unsafeEncode(row.role, sb)
    }
  }

  given reads: Reads[UserRow] = {
    Reads[UserRow](json => JsResult.fromTry(
        Try(
          UserRow(
            id = json.\("id").as(UserId.reads),
            email = json.\("email").as(Email.reads),
            name = json.\("name").as(Reads.StringReads),
            createdAt = json.\("created_at").toOption.map(_.as(TypoLocalDateTime.reads)),
            departmentId = json.\("department_id").toOption.map(_.as(DepartmentId.reads)),
            status = json.\("status").toOption.map(_.as(UserStatus.reads)),
            verified = json.\("verified").toOption.map(_.as(Reads.BooleanReads)),
            managerId = json.\("manager_id").toOption.map(_.as(UserId.reads)),
            role = json.\("role").toOption.map(_.as(UserRole.reads))
          )
        )
      ),
    )
  }

  def rowParser(idx: Int): RowParser[UserRow] = {
    RowParser[UserRow] { row =>
      Success(
        UserRow(
          id = row(idx + 0)(using UserId.column),
          email = row(idx + 1)(using Email.column),
          name = row(idx + 2)(using Column.columnToString),
          createdAt = row(idx + 3)(using Column.columnToOption(using TypoLocalDateTime.column)),
          departmentId = row(idx + 4)(using Column.columnToOption(using DepartmentId.column)),
          status = row(idx + 5)(using Column.columnToOption(using UserStatus.column)),
          verified = row(idx + 6)(using Column.columnToOption(using Column.columnToBoolean)),
          managerId = row(idx + 7)(using Column.columnToOption(using UserId.column)),
          role = row(idx + 8)(using Column.columnToOption(using UserRole.column))
        )
      )
    }
  }

  given writes: OWrites[UserRow] = {
    OWrites[UserRow](o =>
      new JsObject(ListMap[String, JsValue](
        "id" -> UserId.writes.writes(o.id),
        "email" -> Email.writes.writes(o.email),
        "name" -> Writes.StringWrites.writes(o.name),
        "created_at" -> Writes.OptionWrites(using TypoLocalDateTime.writes).writes(o.createdAt),
        "department_id" -> Writes.OptionWrites(using DepartmentId.writes).writes(o.departmentId),
        "status" -> Writes.OptionWrites(using UserStatus.writes).writes(o.status),
        "verified" -> Writes.OptionWrites(using Writes.BooleanWrites).writes(o.verified),
        "manager_id" -> Writes.OptionWrites(using UserId.writes).writes(o.managerId),
        "role" -> Writes.OptionWrites(using UserRole.writes).writes(o.role)
      ))
    )
  }
}